# 宝塔面板部署指南

## 📋 概述

本指南详细介绍如何在安装了宝塔面板的服务器上部署本项目，包括环境配置、数据库导入、项目部署等完整流程。

## 🛠️ 环境要求

### 服务器配置
- **操作系统**：CentOS 7+ / Ubuntu 18+ / Debian 9+
- **内存**：至少 2GB RAM
- **硬盘**：至少 20GB 可用空间
- **宝塔面板**：7.7.0 或更高版本

### 软件环境
- **Node.js**：16.x 或更高版本
- **MySQL**：5.7 或 8.0
- **Nginx**：1.18 或更高版本
- **PM2**：进程管理器

## 🚀 一条龙部署流程

### 第一步：宝塔面板基础配置

#### 1.1 安装必要软件
在宝塔面板 → 软件商店中安装：
- ✅ **MySQL 8.0**
- ✅ **Nginx 1.20+**
- ✅ **Node.js 版本管理器**
- ✅ **PM2 管理器**

#### 1.2 配置Node.js环境
```bash
# 在宝塔终端中执行
# 安装Node.js 18.x
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs

# 验证安装
node --version
npm --version

# 安装PM2
npm install -g pm2
```

### 第二步：创建数据库

#### 2.1 在宝塔面板创建数据库
1. 进入 **数据库** → **MySQL**
2. 点击 **添加数据库**
3. 填写信息：
   - **数据库名**：`author_center`
   - **用户名**：`author_center_user`
   - **密码**：生成强密码（记录下来）
   - **访问权限**：本地服务器

#### 2.2 配置数据库权限
```sql
-- 在宝塔数据库管理中执行
GRANT ALL PRIVILEGES ON author_center.* TO 'author_center_user'@'localhost';
FLUSH PRIVILEGES;
```

### 第三步：上传项目文件

#### 3.1 创建项目目录
在宝塔面板 → 文件管理中：
```
/www/wwwroot/vue-manage-system/
├── backend/
├── frontend/
└── uploads/
```

#### 3.2 上传文件
将以下文件上传到服务器：
- 整个项目文件夹
- 特别注意上传 `backend/sql/clean_database_with_admins.sql`

#### 3.3 设置文件权限
```bash
# 在宝塔终端中执行
cd /www/wwwroot/vue-manage-system
chown -R www:www .
chmod -R 755 .
chmod -R 777 uploads/
```

### 第四步：导入数据库

#### 4.1 方法一：使用宝塔面板导入
1. 进入 **数据库** → 点击数据库名 → **导入**
2. 选择上传 `clean_database_with_admins.sql`
3. 点击导入

#### 4.2 方法二：使用命令行导入
```bash
# 在宝塔终端中执行
cd /www/wwwroot/vue-manage-system
mysql -u author_center_user -p author_center < backend/sql/clean_database_with_admins.sql
```

#### 4.3 验证导入结果
```sql
-- 在宝塔数据库管理中执行
USE author_center;
SHOW TABLES;
SELECT COUNT(*) FROM managers WHERE status = 1;
```

### 第五步：配置后端环境

#### 5.1 创建环境配置文件
在 `/www/wwwroot/vue-manage-system/backend/server/.env`：
```env
# 数据库配置
DB_HOST=localhost
DB_USER=author_center_user
DB_PASS=你的数据库密码
DB_NAME=author_center

# 服务器配置
PORT=3001
NODE_ENV=production

# JWT配置
JWT_SECRET=your-super-secret-jwt-key-here

# 文件上传配置
UPLOAD_PATH=/www/wwwroot/vue-manage-system/uploads
```

#### 5.2 安装后端依赖
```bash
# 在宝塔终端中执行
cd /www/wwwroot/vue-manage-system/backend/server
npm install --production
```

#### 5.3 启动后端服务
```bash
# 使用PM2启动
cd /www/wwwroot/vue-manage-system/backend/server
pm2 start npm --name "vue-manage-backend" -- run start
pm2 save
pm2 startup
```

### 第六步：配置前端环境

#### 6.1 创建前端环境配置
在 `/www/wwwroot/vue-manage-system/frontend/.env.production`：
```env
VITE_API_BASE_URL=https://你的域名/api
VITE_UPLOAD_URL=https://你的域名/uploads
```

#### 6.2 构建前端项目
```bash
# 在宝塔终端中执行
cd /www/wwwroot/vue-manage-system/frontend
npm install
npm run build
```

### 第七步：配置Nginx

#### 7.1 在宝塔面板添加站点
1. 进入 **网站** → **添加站点**
2. 填写域名信息
3. 根目录设置为：`/www/wwwroot/vue-manage-system/frontend/dist`

#### 7.2 配置Nginx反向代理
在宝塔面板 → 网站 → 设置 → 配置文件中添加：

```nginx
server {
    listen 80;
    server_name 你的域名;
    
    # 前端静态文件
    location / {
        root /www/wwwroot/vue-manage-system/frontend/dist;
        try_files $uri $uri/ /index.html;
        index index.html;
    }
    
    # API反向代理
    location /api/ {
        proxy_pass http://127.0.0.1:3001/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 处理跨域
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods 'GET, POST, PUT, DELETE, OPTIONS';
        add_header Access-Control-Allow-Headers 'DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization';
        
        if ($request_method = 'OPTIONS') {
            return 204;
        }
    }
    
    # 文件上传目录
    location /uploads/ {
        alias /www/wwwroot/vue-manage-system/uploads/;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }
    
    # 安全配置
    location ~ /\. {
        deny all;
    }
    
    # 日志配置
    access_log /www/wwwlogs/vue-manage-system.log;
    error_log /www/wwwlogs/vue-manage-system.error.log;
}
```

#### 7.3 配置SSL证书（推荐）
1. 在宝塔面板 → 网站 → SSL
2. 选择 Let's Encrypt 免费证书
3. 申请并部署证书

### 第八步：配置防火墙和安全

#### 8.1 宝塔面板安全配置
1. **面板设置** → 修改默认端口
2. **安全** → 配置SSH端口
3. **防火墙** → 开放必要端口：
   - 80 (HTTP)
   - 443 (HTTPS)
   - 3001 (后端API，仅内网)

#### 8.2 数据库安全配置
```sql
-- 删除不必要的用户
DROP USER IF EXISTS ''@'localhost';
DROP USER IF EXISTS ''@'%';

-- 修改root密码
ALTER USER 'root'@'localhost' IDENTIFIED BY '强密码';
FLUSH PRIVILEGES;
```

### 第九步：监控和维护

#### 9.1 配置PM2监控
```bash
# 查看进程状态
pm2 status

# 查看日志
pm2 logs vue-manage-backend

# 重启服务
pm2 restart vue-manage-backend

# 监控面板
pm2 monit
```

#### 9.2 配置自动备份
在宝塔面板 → 计划任务中添加：
```bash
# 每日凌晨2点备份数据库
0 2 * * * mysqldump -u author_center_user -p密码 author_center > /www/backup/author_center_$(date +\%Y\%m\%d).sql

# 每周备份项目文件
0 3 * * 0 tar -czf /www/backup/vue-manage-system_$(date +\%Y\%m\%d).tar.gz /www/wwwroot/vue-manage-system
```

## 🔧 常见问题解决

### 问题1：Node.js版本不兼容
```bash
# 使用nvm管理Node.js版本
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
source ~/.bashrc
nvm install 18
nvm use 18
```

### 问题2：数据库连接失败
1. 检查数据库服务状态
2. 验证用户名密码
3. 确认防火墙设置
4. 检查MySQL配置文件

### 问题3：文件上传权限问题
```bash
# 设置正确的文件权限
chown -R www:www /www/wwwroot/vue-manage-system/uploads
chmod -R 755 /www/wwwroot/vue-manage-system/uploads
```

### 问题4：前端路由404问题
确保Nginx配置中有 `try_files $uri $uri/ /index.html;`

## 📊 性能优化建议

### 数据库优化
```sql
-- 添加索引
ALTER TABLE orders ADD INDEX idx_created_at (created_at);
ALTER TABLE users ADD INDEX idx_status (status);

-- 配置MySQL参数
SET GLOBAL innodb_buffer_pool_size = 1073741824; -- 1GB
```

### Nginx优化
```nginx
# 启用gzip压缩
gzip on;
gzip_vary on;
gzip_min_length 1024;
gzip_types text/plain text/css application/json application/javascript text/xml application/xml;

# 静态文件缓存
location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
}
```

## 🎯 部署验证清单

部署完成后，请验证以下功能：

- [ ] 网站可以正常访问
- [ ] 管理员可以正常登录
- [ ] 数据库连接正常
- [ ] 文件上传功能正常
- [ ] API接口响应正常
- [ ] SSL证书配置正确
- [ ] PM2进程运行稳定
- [ ] 日志记录正常

## 📞 技术支持

### 管理员账户信息
| 账户 | 手机号 | 密码 |
|------|--------|------|
| 超级管理员1 | 13800000001 | admin123456 |
| 超级管理员2 | 13800000002 | admin123456 |
| 超级管理员3 | 13800000003 | admin123456 |
| 超级管理员4 | 13800000004 | admin123456 |

### 重要文件路径
- **项目根目录**：`/www/wwwroot/vue-manage-system/`
- **后端配置**：`/www/wwwroot/vue-manage-system/backend/server/.env`
- **前端构建**：`/www/wwwroot/vue-manage-system/frontend/dist/`
- **上传目录**：`/www/wwwroot/vue-manage-system/uploads/`
- **数据库备份**：`/www/backup/`

### 常用命令
```bash
# 查看服务状态
pm2 status

# 重启后端服务
pm2 restart vue-manage-backend

# 查看实时日志
pm2 logs vue-manage-backend --lines 100

# 重新构建前端
cd /www/wwwroot/vue-manage-system/frontend && npm run build

# 重启Nginx
systemctl restart nginx

# 查看数据库状态
systemctl status mysql
```

---

*最后更新：2025年1月*
*适用于宝塔面板 7.7.0+ 版本*